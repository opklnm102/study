# [Security] Aqua Trivy - Vulnerability and Misconfiguration Scanning
> date - 2022.06.15  
> keyworkd - security, cve, vulnerability, vulnerability scanner  
> 취약점 스캐너 trivy에 대해 정리

<br>

## What is trivy?
* container images, file systems, git repository에 대한 configuration issues, hard-coded secret, vulnerability scanner
* targets
  * container image
  * file system
  * git repository(remote)
  * kubernetes cluster or resource
* scanners
  * SBOM - OS packages and software dependencies in use
  * CVEs - Known vulnerabilities
  * IaC(Infrastructure as Code) misconfigurations
  * Sensitive information and secrets
* CI/CD pipeline에 [trivy-action](https://github.com/aquasecurity/trivy-action)을 포함하면 자동으로 취약점을 발견할 수 있다
* 다양한 OS를 지원하는 것을 [Supported OS](https://aquasecurity.github.io/trivy/v0.28.1/docs/vulnerability/detection/os/)에서 확인할 수 있다


<br>

## Installation
* Homebrew
```sh
$ brew install aquasecurity/trivy/trivy
```

* Container image
```sh
## .zshrc
alias trivy="docker run -it --rm aquasec/trivy"

## macOS + host machine의 image scan
alias trivy="docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy"

## macOS + current directory for IaC misconfigurations
alias trivy-misconfig="docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock -v $HOME/Library/Caches:/root/.cache/ -v $PWD:/myapp aquasec/trivy config /myapp"
```


<br>

## Usage

### Scan image
```sh
$ trivy image [image]
```

<br>

### Scan severity [level] image 
```sh
$ trivy image --severity [UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL] [image]

## example
$ trivy image --severity HIGH,CRITICAL python:3.10.5-slim
...

## example
$ trivy image --severity CRITICAL python:3.10.5-slim
2022-06-14T17:46:09.629Z	INFO	Detected OS: debian
2022-06-14T17:46:09.629Z	INFO	Detecting Debian vulnerabilities...
2022-06-14T17:46:09.697Z	INFO	Number of language-specific files: 1
2022-06-14T17:46:09.697Z	INFO	Detecting python-pkg vulnerabilities...

python:3.10.5-slim (debian 11.3)

Total: 3 (CRITICAL: 3)

┌──────────────┬───────────────┬──────────┬───────────────────┬───────────────┬─────────────────────────────────────────────────────────────┐
│   Library    │ Vulnerability │ Severity │ Installed Version │ Fixed Version │                            Title                            │
├──────────────┼───────────────┼──────────┼───────────────────┼───────────────┼─────────────────────────────────────────────────────────────┤
│ libdb5.3     │ CVE-2019-8457 │ CRITICAL │ 5.3.28+dfsg1-0.8  │               │ sqlite: heap out-of-bound read in function rtreenode()      │
│              │               │          │                   │               │ https://avd.aquasec.com/nvd/cve-2019-8457                   │
├──────────────┼───────────────┼──────────┼───────────────────┼───────────────┼─────────────────────────────────────────────────────────────┤
│ libpcre2-8-0 │ CVE-2022-1586 │ CRITICAL │ 10.36-2           │               │ pcre2: Out-of-bounds read in compile_xclass_matchingpath in │
│              │               │          │                   │               │ pcre2_jit_compile.c                                         │
│              │               │          │                   │               │ https://avd.aquasec.com/nvd/cve-2022-1586                   │
│              ├───────────────┤          │                   ├───────────────┼─────────────────────────────────────────────────────────────┤
│              │ CVE-2022-1587 │          │                   │               │ pcre2: Out-of-bounds read in get_recurse_data_length in     │
│              │               │          │                   │               │ pcre2_jit_compile.c                                         │
│              │               │          │                   │               │ https://avd.aquasec.com/nvd/cve-2022-1587                   │
└──────────────┴───────────────┴──────────┴───────────────────┴───────────────┴─────────────────────────────────────────────────────────────┘

Python (python-pkg)

Total: 0 (CRITICAL: 0)
```

<br>

### Display only fixed vulnerabilities
```sh
$ trivy image --ignore-unfixed [image]

## example
$ trivy image --ignore-unfixed python:3.10.5-slim
```

<br>

### Scan Output file
```sh
$ trivy image --output [output path] [image]

## example
$ trivy image --output result.txt python:3.10.5-slim
```

<br>

### Scan config
```sh
$ trivy image --security-checks config [image]
```


<br><br>

> #### Reference
> * [aquasecurity/trivy - GitHub](https://github.com/aquasecurity/trivy)
> * [aquasec/trivy - Docker Hub](https://hub.docker.com/r/aquasec/trivy/)
